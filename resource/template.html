<!DOCTYPE html>
<html>
<head>
    <title>RateIt - Quick Rating</title>
    <link rel="stylesheet" href="/resource/style.css">
</head>
<body>
    <div class="menu-bar">
        <div class="menu-content">
            <div class="dropdown no-bg">
                <button class="no-bg menu-btn">Features &#9662;</button>
                <div class="dropdown-content">
                    <button onclick="showGraphPopup()">Graph</button>
                    <button onclick="openSettingsPopup()">Customize Theme</button>
                    <button onclick="openUploadPopup()">Upload Data</button>
                    <button onclick="downloadData('csv')">Download CSV</button>
                    <button onclick="downloadData('json')">Download JSON</button>
                    <button onclick="resetDatabases()" class="danger">Reset Data</button>
                </div>
            </div>
            <div class="dropdown no-bg">
                <button class="no-bg menu-btn">Mapping Buttons &#9662;</button>
                <div class="dropdown-content">
                    {% for value in range(1, num_buttons+1) %}
                        <button onclick="startMapping({{value}})">Map Rating {{value}}</button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <!-- Settings Popup -->
    <div id="settings-popup" class="popup-overlay">
        <div class="popup settings-popup">
            <button onclick="closeSettingsPopup()" class="popup-close">&times;</button>
            <h2 class="popup-title">Customize Theme</h2>
            <form id="theme-form">
                <table class="theme-table">
                    <tr>
                        <td class="theme-label">Text Font:</td>
                        <td class="theme-input">
                            <select id="font-select">
                                <option value="Consolas">Consolas</option>
                                <option value="Arial">Arial</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Tahoma">Tahoma</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Courier New">Courier New</option>
                                <option value="Times New Roman">Times New Roman</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="theme-label">Text Color:</td>
                        <td class="theme-input">
                            <input type="color" id="text-color" value="{{ theme.get('textColor', '#f3f3f3') }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="theme-label">Glow Color:</td>
                        <td class="theme-input">
                            <input type="color" id="glow-color" value="{{ theme.get('glowColor', '#1bd602') }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="theme-label">Heading Color:</td>
                        <td class="theme-input">
                            <input type="color" id="heading-color" value="{{ theme.get('headingColor', '#cfd6da') }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="theme-label">Menu Background:</td>
                        <td class="theme-input">
                            <input type="color" id="menu-bg" value="{{ theme.get('menuBg', '#181b20') }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="theme-label">Background Image:</td>
                        <td class="theme-input">
                            <input type="file" id="bg-upload" accept="image/*">
                            <button type="button" id="bg-upload-btn" class="ml8">Upload</button>
                            <br>
                            <select id="bg-select" class="mt8 minw180">
                                <option value="">-- Default Background --</option>
                            </select>
                            <button type="button" id="bg-delete-btn" class="ml8">Delete</button>
                        </td>
                    </tr>
                </table>
                <div class="theme-actions">
                    <button type="button" onclick="applyThemeSettings()" class="apply-btn">Apply</button>
                    <button type="button" onclick="resetThemeSettings()" class="reset-btn">Reset</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Add Graph Popup -->
    <div id="graph-popup" class="popup-overlay">
        <div class="popup graph-popup">
            <button onclick="closeGraphPopup()" class="popup-close">&times;</button>
            <h2 class="popup-title">Rating Timeline</h2>
            <div class="graph-controls">
                <label>
                    Range:
                    <select id="graph-range">
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="365">Last 365 days</option>
                        <option value="all" selected>All</option>
                    </select>
                </label>
                <label>
                    Group by:
                    <select id="graph-group">
                        <option value="day" selected>Day</option>
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                    </select>
                </label>
            </div>
            <div class="graph-source">
                <span>
                    Data Source:
                    <label>
                        <input type="radio" name="graph-source" id="graph-source-csv" value="csv" checked>
                        CSV
                    </label>
                    <label>
                        <input type="radio" name="graph-source" id="graph-source-json" value="json">
                        JSON
                    </label>
                </span>
            </div>
            <canvas id="rating-chart" width="500" height="260" class="graph-canvas"></canvas>
            <div id="graph-loading" class="graph-loading">Loading...</div>
        </div>
    </div>
    <!-- Upload Popup -->
    <div id="upload-popup" class="popup-overlay">
        <div class="popup upload-popup">
            <button onclick="closeUploadPopup()" class="popup-close">&times;</button>
            <h2 class="popup-title">Upload CSV or JSON</h2>
            <form id="upload-form">
                <input type="file" id="upload-file" accept=".csv,.json" required>
                <select id="upload-type" class="ml10">
                    <option value="csv">CSV</option>
                    <option value="json">JSON</option>
                </select>
                <button type="submit" class="ml10">Upload</button>
            </form>
            <div id="upload-msg" class="upload-msg"></div>
        </div>
    </div>
    <div class="main-content">
        <h1 id="editable-title" class="editable-title" title="Double-click to edit">{{ config.get('title', 'Rate on a scale of 1 to ' ~ num_buttons) if config is defined else 'Rate on a scale of 1 to ' ~ num_buttons }}</h1>
        <!-- Title Edit Popup -->
        <div id="title-edit-popup" class="popup-overlay">
            <div class="popup title-edit-popup">
                <button onclick="closeTitleEditPopup()" class="popup-close">&times;</button>
                <h3 class="popup-title">Edit Title</h3>
                <input type="text" id="title-edit-input" class="title-edit-input">
                <div>
                    <button onclick="saveTitleEdit()" class="apply-btn mr10">Save</button>
                    <button onclick="closeTitleEditPopup()" class="reset-btn">Cancel</button>
                </div>
                <div id="title-edit-msg" class="title-edit-msg"></div>
            </div>
        </div>
        <div class="rating-row">
            {% set rating_keys = {} %}
            {% for key, value in hotkeys.items() %}
                {% if value not in rating_keys %}
                    {% set _ = rating_keys.update({value: [key]}) %}
                {% else %}
                    {% set _ = rating_keys[value].append(key) %}
                {% endif %}
            {% endfor %}
            {% for rating in range(1, num_buttons+1) %}
                <button class="rating-btn" id="rating-btn-{{rating}}" onclick="sendRating({{rating}})">
                    {{rating}}
                    <br>
                    <small class="hotkey-list" id="hotkey-list-{{rating}}">
                        <span class="hotkey-inner">
                            {% if rating in rating_keys %}
                                (Hotkey{{'s' if rating_keys[rating]|length > 1 else ''}}:
                                {{ rating_keys[rating]|join(', ') }})
                            {% else %}
                                &nbsp;
                            {% endif %}
                        </span>
                    </small>
                </button>
            {% endfor %}
        </div>
        <p id="msg"></p>
        <p id="map-msg" class="map-msg"></p>
        <div class="legend-features">
            <fieldset class="features-fieldset">
                <legend class="features-legend">Features</legend>
                <div class="features-grid">
                    <label for="rainbow-glow-checkbox">Rainbow Glow:</label>
                    <span>
                        <input type="checkbox" id="rainbow-glow-checkbox" {% if config.get('rainbow_glow', True) %}checked{% endif %} onchange="toggleRainbowGlow()" />
                    </span>
                    <label>
                        Show Hotkey Display:
                    </label>
                    <span><input type="checkbox" id="toggle-hotkeys" onchange="toggleHotkeyDisplay()" /></span>
                    <label for="num-buttons-slider">Number of Buttons:</label>
                    <span>
                        <input type="range" id="num-buttons-slider" min="1" max="10" value="{{ num_buttons }}">
                        <span id="num-buttons-value">{{ num_buttons }}</span>
                    </span>
                    <label for="max-cols-slider">Max Columns:</label>
                    <span>
                        <input type="range" id="max-cols-slider" min="1" max="10" value="{{ config.get('max_columns', 5) if config is defined else 5 }}">
                        <span id="max-cols-value">{{ config.get('max_columns', 5) if config is defined else 5 }}</span>
                    </span>
                    
                </div>
            </fieldset>
        </div>
    </div>
    <script src="/resource/chart.min.js"></script>
    <script>
        const hotkeys = {{ hotkeys | tojson }};
        let mappingRating = null;
        let numButtons = {{ num_buttons|default(10) }};
        const defaultKeys = [];
        for (let i = 1; i <= Math.min(numButtons, 10); i++) {
            defaultKeys.push(i === 10 ? '0' : String(i));
        }

        function getRatingForKey(key) {
            if (defaultKeys.includes(key)) {
                if (key === '0' && numButtons >= 10) return 10;
                let n = parseInt(key, 10);
                if (!isNaN(n) && n >= 1 && n <= numButtons) return n;
            }
            if (hotkeys.hasOwnProperty(key)) return hotkeys[key];
            if (hotkeys.hasOwnProperty(String(key))) return hotkeys[String(key)];
            if (hotkeys.hasOwnProperty(Number(key))) return hotkeys[Number(key)];
            return null;
        }

        function fitHotkeyLabels() {
            for (let rating = 1; rating <= numButtons; rating++) {
                const btn = document.getElementById('rating-btn-' + rating);
                const label = document.getElementById('hotkey-list-' + rating);
                if (btn && label) {
                    label.style.setProperty('--hotkey-scale', 1);
                    label.style.width = "auto";
                    let scale = 1;
                    const maxWidth = btn.clientWidth - 16;
                    while (label.scrollWidth > maxWidth && scale > 0.5) {
                        scale -= 0.05;
                        label.style.setProperty('--hotkey-scale', scale);
                    }
                    label.style.width = Math.min(label.scrollWidth, maxWidth) + "px";
                    label.style.marginLeft = "auto";
                    label.style.marginRight = "auto";
                    if (document.getElementById('toggle-hotkeys').checked) {
                        label.style.display = "block";
                    }
                }
            }
        }

        function toggleHotkeyDisplay() {
            const checked = document.getElementById('toggle-hotkeys').checked;
            for (let rating = 1; rating <= numButtons; rating++) {
                const label = document.getElementById('hotkey-list-' + rating);
                if (label) {
                    label.style.display = checked ? "block" : "none";
                }
            }
            if (checked) fitHotkeyLabels();
        }

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('toggle-hotkeys').checked = false;
            toggleHotkeyDisplay();
            fitHotkeyLabels();
        });
        window.addEventListener('resize', () => {
            if (document.getElementById('toggle-hotkeys').checked) {
                fitHotkeyLabels();
            }
        });

        function highlightButton(rating) {
            const btn = document.getElementById('rating-btn-' + rating);
            if (btn) {
                btn.classList.add('active-highlight');
                setTimeout(() => btn.classList.remove('active-highlight'), 200);
            }
        }

        document.addEventListener('keydown', function(e) {
            let key = e.key;
            if (e.code && e.code.startsWith('Numpad') && e.code.length === 7) {
                key = e.code.slice(-1);
                if (key === '0') key = '0';
            }
            if (mappingRating !== null) {
                if (defaultKeys.includes(key)) {
                    document.getElementById('map-msg').innerText = `Default keys 1-${numButtons >= 10 ? '0' : numButtons} are always mapped.`;
                } else {
                    fetch('/map_hotkey', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({key: key, rating: parseInt(mappingRating)})
                    })
                    .then(res => res.json())
                    .then(function(data) {
                        document.getElementById('map-msg').innerText = data.message;
                        if (data.success) {
                            setTimeout(() => location.reload(), 700);
                        }
                    });
                }
                mappingRating = null;
            } else {
                const rating = getRatingForKey(key);
                if (rating && Number(rating) >= 1 && Number(rating) <= numButtons) {
                    sendRating(Number(rating));
                    highlightButton(Number(rating));
                }
            }
        });

        function sendRating(rating) {
            fetch('/rate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rating: rating})
            })
            .then(res => res.json())
            .then(function(data) {
                const msgElem = document.getElementById('msg');
                msgElem.innerText = 'Saved';
                msgElem.style.opacity = '1';
                msgElem.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    msgElem.style.opacity = '0';
                }, 1000);
                setTimeout(() => {
                    msgElem.innerText = '';
                    msgElem.style.transition = '';
                    msgElem.style.opacity = '';
                }, 1600);
            });
            highlightButton(rating);
        }

        function startMapping(rating) {
            mappingRating = rating;
            document.getElementById('map-msg').innerText = "Press a key to map to rating " + rating + " (except 1-5).";
        }

        function openSettingsPopup() {
            document.getElementById('settings-popup').style.display = 'flex';
        }
        function closeSettingsPopup() {
            document.getElementById('settings-popup').style.display = 'none';
        }

        function showGraphPopup() {
            document.getElementById('graph-popup').style.display = 'flex';
            loadGraphData();
        }
        function closeGraphPopup() {
            document.getElementById('graph-popup').style.display = 'none';
        }

        function openUploadPopup() {
            document.getElementById('upload-popup').style.display = 'flex';
            document.getElementById('upload-msg').innerText = '';
            document.getElementById('upload-form').reset();
        }
        function closeUploadPopup() {
            document.getElementById('upload-popup').style.display = 'none';
        }

        let chartInstance = null;
        function loadGraphData() {
            document.getElementById('graph-loading').style.display = 'block';
            const range = document.getElementById('graph-range').value;
            const group = document.getElementById('graph-group').value;
            const source = document.getElementById('graph-source-json').checked ? 'json' : 'csv';
            fetch(`/timeline_data?range=${encodeURIComponent(range)}&group=${encodeURIComponent(group)}&source=${encodeURIComponent(source)}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        document.getElementById('graph-loading').innerText = 'Failed to load data.';
                        return;
                    }
                    document.getElementById('graph-loading').style.display = 'none';
                    const timeline = data.timeline;
                    const labels = timeline.map(e => e.date);
                    const avgRatings = timeline.map(e => e.avg_rating);
                    const counts = timeline.map(e => e.count);

                    const ctx = document.getElementById('rating-chart').getContext('2d');
                    if (chartInstance) {
                        chartInstance.destroy();
                    }
                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Average Rating',
                                data: avgRatings,
                                borderColor: '#1bd602',
                                backgroundColor: 'rgba(27,214,2,0.08)',
                                fill: true,
                                tension: 0.2,
                                pointRadius: 4,
                                pointBackgroundColor: '#1bd602',
                                yAxisID: 'y',
                            }, {
                                label: 'Count',
                                data: counts,
                                borderColor: '#3faaff',
                                backgroundColor: 'rgba(63,170,255,0.08)',
                                fill: false,
                                type: 'bar',
                                yAxisID: 'y1',
                                order: 2,
                                barPercentage: 0.4,
                                categoryPercentage: 0.7,
                            }]
                        },
                        options: {
                            responsive: false,
                            plugins: {
                                legend: { labels: { color: '#cfd6da' } },
                                tooltip: { mode: 'index', intersect: false }
                            },
                            scales: {
                                x: {
                                    ticks: { color: '#cfd6da' },
                                    grid: { color: '#353a45' }
                                },
                                y: {
                                    beginAtZero: true,
                                    min: 0,
                                    title: { display: true, text: 'Average Rating', color: '#cfd6da' },
                                    ticks: { color: '#1bd602' },
                                    grid: { color: '#353a45' }
                                },
                                y1: {
                                    beginAtZero: true,
                                    position: 'right',
                                    title: { display: true, text: 'Count', color: '#3faaff' },
                                    ticks: { color: '#3faaff' },
                                    grid: { drawOnChartArea: false }
                                }
                            }
                        }
                    });
                })
                .catch(() => {
                    document.getElementById('graph-loading').innerText = 'Failed to load data.';
                });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const rangeSel = document.getElementById('graph-range');
            const groupSel = document.getElementById('graph-group');
            const sourceCsv = document.getElementById('graph-source-csv');
            const sourceJson = document.getElementById('graph-source-json');
            if (rangeSel && groupSel) {
                rangeSel.value = "all";
                groupSel.value = "day";
                rangeSel.onchange = loadGraphData;
                groupSel.onchange = loadGraphData;
            }
            if (sourceCsv && sourceJson) {
                sourceCsv.onchange = loadGraphData;
                sourceJson.onchange = loadGraphData;
            }
        });

        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                let date = new Date();
                date.setTime(date.getTime() + (days*24*60*60*1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (encodeURIComponent(value) || "")  + expires + "; path=/";
        }
        function getCookie(name) {
            let nameEQ = name + "=";
            let ca = document.cookie.split(';');
            for(let i=0;i < ca.length;i++) {
                let c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return decodeURIComponent(c.substring(nameEQ.length,c.length));
            }
            return null;
        }
        function eraseCookie(name) {
            document.cookie = name+'=; Max-Age=-99999999; path=/';
        }

        function saveThemeToCookie(theme) {
            setCookie('rateit_theme', JSON.stringify(theme), 365);
        }
        function loadThemeFromCookie() {
            let data = getCookie('rateit_theme');
            if (!data) return null;
            try {
                return JSON.parse(data);
            } catch {
                return null;
            }
        }

        function applyThemeSettings() {
            let theme = {
                font: document.getElementById('font-select').value,
                textColor: document.getElementById('text-color').value,
                glowColor: document.getElementById('glow-color').value,
                headingColor: document.getElementById('heading-color').value,
                menuBg: document.getElementById('menu-bg').value,
                bgImg: null
            };
            document.body.style.fontFamily = theme.font;
            document.body.style.color = theme.textColor;
            document.querySelectorAll('h1,h2,h3,h4,h5').forEach(e => e.style.color = theme.headingColor);
            document.querySelectorAll('.rating-btn').forEach(btn => {
                btn.style.boxShadow = `0 0 8px 2px ${theme.glowColor}cc, 0 6px 16px 0 rgba(0,0,0,0.35), 0 2px 4px 0 rgba(0,0,0,0.25), inset 0 2px 8px 0 #444`;
            });
            document.querySelectorAll('.menu-bar').forEach(e => e.style.background = theme.menuBg);
            let bgInput = document.getElementById('bg-upload');
            let bgSelect = document.getElementById('bg-select');
            if (bgInput.files && bgInput.files[0]) {
                let reader = new FileReader();
                reader.onload = function(e) {
                    setBackgroundImage(e.target.result);
                    theme.bgImg = e.target.result;
                    saveThemeToCookie(theme);
                    postThemeToBackend(theme);
                };
                reader.readAsDataURL(bgInput.files[0]);
            } else if (bgSelect.value) {
                let url = '/backgrounds/' + encodeURIComponent(bgSelect.value);
                setBackgroundImage(url);
                theme.bgImg = url;
                saveThemeToCookie(theme);
                postThemeToBackend(theme);
            } else {
                let prevTheme = loadThemeFromCookie();
                if (prevTheme && prevTheme.bgImg) {
                    setBackgroundImage(prevTheme.bgImg);
                    theme.bgImg = prevTheme.bgImg;
                } else {
                    setBackgroundImage('');
                }
                saveThemeToCookie(theme);
                postThemeToBackend(theme);
            }
            closeSettingsPopup();
        }

        function resetThemeSettings() {
            let theme = {
                font: 'Consolas',
                textColor: '#f3f3f3',
                glowColor: '#1bd602',
                headingColor: '#cfd6da',
                menuBg: '#181b20',
                bgImg: null
            };
            document.body.style.fontFamily = '';
            document.body.style.color = '';
            document.querySelectorAll('h1,h2,h3,h4,h5').forEach(e => e.style.color = '');
            document.querySelectorAll('.rating-btn').forEach(btn => btn.style.boxShadow = '');
            document.querySelectorAll('.menu-bar').forEach(e => e.style.background = '');
            document.body.style.backgroundImage = '';
            document.body.style.backgroundSize = '';
            document.getElementById('font-select').value = theme.font;
            document.getElementById('text-color').value = theme.textColor;
            document.getElementById('glow-color').value = theme.glowColor;
            document.getElementById('heading-color').value = theme.headingColor;
            document.getElementById('menu-bg').value = theme.menuBg;
            document.getElementById('bg-upload').value = '';
            eraseCookie('rateit_theme');

            fetch('/set_num_buttons', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({num_buttons: 5})
            }).then(() => {
                fetch('/set_max_columns', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({max_columns: 5})
                }).then(() => {
                    postThemeToBackend(theme, () => location.reload());
                });
            });

            closeSettingsPopup();
        }

        function postThemeToBackend(theme, cb) {
            fetch('/set_theme', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(theme)
            }).then(() => { if (cb) cb(); });
        }

        function getThemeFromForm() {
            return {
                font: document.getElementById('font-select').value,
                textColor: document.getElementById('text-color').value,
                glowColor: document.getElementById('glow-color').value,
                headingColor: document.getElementById('heading-color').value,
                menuBg: document.getElementById('menu-bg').value,
            };
        }

        document.addEventListener('DOMContentLoaded', function() {
            ['font-select', 'text-color', 'glow-color', 'heading-color', 'menu-bg'].forEach(function(id) {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', function() {
                        let theme = getThemeFromForm();
                        postThemeToBackend(theme);
                    });
                }
            });
        });

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('toggle-hotkeys').checked = false;
            toggleHotkeyDisplay();
            fitHotkeyLabels();
            let theme = {{ theme | tojson }};
            if (theme) {
                document.getElementById('font-select').value = theme.font || 'Consolas';
                document.getElementById('text-color').value = theme.textColor || '#f3f3f3';
                document.getElementById('glow-color').value = theme.glowColor || '#1bd602';
                document.getElementById('heading-color').value = theme.headingColor || '#cfd6da';
                document.getElementById('menu-bg').value = theme.menuBg || '#181b20';
                document.body.style.fontFamily = theme.font || 'Consolas';
                document.body.style.color = theme.textColor || '';
                document.querySelectorAll('h1,h2,h3,h4,h5').forEach(e => e.style.color = theme.headingColor || '');
                document.querySelectorAll('.rating-btn').forEach(btn => btn.style.boxShadow = `0 0 8px 2px ${(theme.glowColor || '#1bd602')}cc, 0 6px 16px 0 rgba(0,0,0,0.35), 0 2px 4px 0 rgba(0,0,0,0.25), inset 0 2px 8px 0 #444`);
                document.querySelectorAll('.menu-bar').forEach(e => e.style.background = theme.menuBg || '');
                if (theme.bgImg) {
                    document.body.style.backgroundImage = `url('${theme.bgImg}')`;
                    document.body.style.backgroundSize = 'cover';
                }
            } else {
                document.getElementById('font-select').value = 'Consolas';
                document.body.style.fontFamily = 'Consolas';
            }
        });

        function refreshBgSelect(selected) {
            fetch('/list_backgrounds')
                .then(res => res.json())
                .then(files => {
                    const sel = document.getElementById('bg-select');
                    sel.innerHTML = '<option value="">-- Default Background --</option>';
                    files.forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = f;
                        opt.textContent = f;
                        if (selected && selected === f) opt.selected = true;
                        sel.appendChild(opt);
                    });
                });
        }

        document.addEventListener('DOMContentLoaded', function() {
            refreshBgSelect();
            const slider = document.getElementById('num-buttons-slider');
            const valueSpan = document.getElementById('num-buttons-value');
            if (slider && valueSpan) {
                slider.value = numButtons;
                valueSpan.textContent = numButtons;
                slider.oninput = function() {
                    valueSpan.textContent = this.value;
                };
                slider.onchange = function() {
                    fetch('/set_num_buttons', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({num_buttons: this.value})
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert(data.message || "Failed to set number of buttons.");
                        }
                    });
                };
            }
        });

        document.getElementById('bg-upload-btn').onclick = function() {
            const fileInput = document.getElementById('bg-upload');
            if (!fileInput.files || !fileInput.files[0]) {
                alert('Please select an image file.');
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            fetch('/upload_background', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    refreshBgSelect(data.filename);
                    document.getElementById('bg-upload').value = '';
                } else {
                    alert(data.message || 'Upload failed.');
                }
            });
        };

        function setBackgroundImage(url) {
            if (url) {
                document.body.style.backgroundImage = `url('${url}')`;
                document.body.style.backgroundSize = 'contain';
                document.body.style.backgroundRepeat = 'no-repeat';
                document.body.style.backgroundPosition = 'center center';
            } else {
                document.body.style.backgroundImage = '';
                document.body.style.backgroundSize = '';
                document.body.style.backgroundRepeat = '';
                document.body.style.backgroundPosition = '';
            }
        }

        document.getElementById('bg-delete-btn').onclick = function() {
            const sel = document.getElementById('bg-select');
            const filename = sel.value;
            if (!filename) {
                alert('Select an image to delete.');
                return;
            }
            if (!confirm('Delete background image "' + filename + '"?')) return;
            fetch('/delete_background', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({filename})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    refreshBgSelect();
                    let theme = loadThemeFromCookie();
                    if (theme && theme.bgImg && theme.bgImg.includes('/backgrounds/' + filename)) {
                        theme.bgImg = null;
                        saveThemeToCookie(theme);
                        setBackgroundImage('');
                    }
                } else {
                    alert(data.message || 'Delete failed.');
                }
            });
        };

        document.getElementById('bg-select').onchange = function() {
            const filename = this.value;
            if (filename) {
                const url = '/backgrounds/' + encodeURIComponent(filename);
                setBackgroundImage(url);
                let theme = loadThemeFromCookie() || {};
                theme.bgImg = url;
                saveThemeToCookie(theme);
            } else {
                setBackgroundImage('');
                let theme = loadThemeFromCookie() || {};
                theme.bgImg = null;
                saveThemeToCookie(theme);
            }
        };

        function applyThemeSettings() {
            let theme = {
                font: document.getElementById('font-select').value,
                textColor: document.getElementById('text-color').value,
                glowColor: document.getElementById('glow-color').value,
                headingColor: document.getElementById('heading-color').value,
                menuBg: document.getElementById('menu-bg').value,
                bgImg: null
            };
            document.body.style.fontFamily = theme.font;
            document.body.style.color = theme.textColor;
            document.querySelectorAll('h1,h2,h3,h4,h5').forEach(e => e.style.color = theme.headingColor);
            document.querySelectorAll('.rating-btn').forEach(btn => {
                btn.style.boxShadow = `0 0 8px 2px ${theme.glowColor}cc, 0 6px 16px 0 rgba(0,0,0,0.35), 0 2px 4px 0 rgba(0,0,0,0.25), inset 0 2px 8px 0 #444`;
            });
            document.querySelectorAll('.menu-bar').forEach(e => e.style.background = theme.menuBg);
            let bgInput = document.getElementById('bg-upload');
            let bgSelect = document.getElementById('bg-select');
            if (bgInput.files && bgInput.files[0]) {
                let reader = new FileReader();
                reader.onload = function(e) {
                    setBackgroundImage(e.target.result);
                    theme.bgImg = e.target.result;
                    saveThemeToCookie(theme);
                    postThemeToBackend(theme);
                };
                reader.readAsDataURL(bgInput.files[0]);
            } else if (bgSelect.value) {
                let url = '/backgrounds/' + encodeURIComponent(bgSelect.value);
                setBackgroundImage(url);
                theme.bgImg = url;
                saveThemeToCookie(theme);
                postThemeToBackend(theme);
            } else {
                let prevTheme = loadThemeFromCookie();
                if (prevTheme && prevTheme.bgImg) {
                    setBackgroundImage(prevTheme.bgImg);
                    theme.bgImg = prevTheme.bgImg;
                } else {
                    setBackgroundImage('');
                }
                saveThemeToCookie(theme);
            }
            closeSettingsPopup();
        }

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('toggle-hotkeys').checked = false;
            toggleHotkeyDisplay();
            fitHotkeyLabels();
            let theme = loadThemeFromCookie();
            if (theme && theme.bgImg && theme.bgImg.startsWith('/backgrounds/')) {
                let fname = theme.bgImg.split('/backgrounds/')[1];
                refreshBgSelect(fname);
            } else {
                refreshBgSelect();
            }
            if (theme) {
                document.getElementById('font-select').value = theme.font || 'Consolas';
                document.getElementById('text-color').value = theme.textColor || '#f3f3f3';
                document.getElementById('glow-color').value = theme.glowColor || '#1bd602';
                document.getElementById('heading-color').value = theme.headingColor || '#cfd6da';
                document.getElementById('menu-bg').value = theme.menuBg || '#181b20';
                document.body.style.fontFamily = theme.font || 'Consolas';
                document.body.style.color = theme.textColor || '';
                document.querySelectorAll('h1,h2,h3,h4,h5').forEach(e => e.style.color = theme.headingColor || '');
                document.querySelectorAll('.rating-btn').forEach(btn => btn.style.boxShadow = `0 0 8px 2px ${(theme.glowColor || '#1bd602')}cc, 0 6px 16px 0 rgba(0,0,0,0.35), 0 2px 4px 0 rgba(0,0,0,0.25), inset 0 2px 8px 0 #444`);
                document.querySelectorAll('.menu-bar').forEach(e => e.style.background = theme.menuBg || '');
                if (theme.bgImg) {
                    document.body.style.backgroundImage = `url('${theme.bgImg}')`;
                    document.body.style.backgroundSize = 'cover';
                }
            } else {
                document.getElementById('font-select').value = 'Consolas';
                document.body.style.fontFamily = 'Consolas';
            }
        });

        document.getElementById('upload-form').onsubmit = function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('upload-file');
            const type = document.getElementById('upload-type').value;
            const msg = document.getElementById('upload-msg');
            if (!fileInput.files || !fileInput.files[0]) {
                msg.innerText = 'Please select a file.';
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('type', type);
            fetch('/upload_data', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                msg.innerText = data.message || (data.success ? 'Upload successful.' : 'Upload failed.');
                if (data.success) setTimeout(() => { closeUploadPopup(); location.reload(); }, 1200);
            })
            .catch(() => { msg.innerText = 'Upload failed.'; });
        };

        function downloadData(type) {
            window.location = '/download_data/' + type;
        }

        function resetDatabases() {
            if (!confirm('This will backup and clear both ratings.csv and ratings.json. Continue?')) return;
            fetch('/reset_data', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    alert(data.message || (data.success ? 'Reset successful.' : 'Reset failed.'));
                    if (data.success) location.reload();
                })
                .catch(() => alert('Reset failed.'));
        }

        document.addEventListener('DOMContentLoaded', function() {
            const maxColsSlider = document.getElementById('max-cols-slider');
            const maxColsValue = document.getElementById('max-cols-value');
            let initialMaxCols = parseInt(maxColsSlider.value);
            setMaxColumns(initialMaxCols);
            if (maxColsSlider && maxColsValue) {
                maxColsValue.textContent = maxColsSlider.value;
                maxColsSlider.oninput = function() {
                    maxColsValue.textContent = this.value;
                    setMaxColumns(parseInt(this.value));
                };
                maxColsSlider.onchange = function() {
                    fetch('/set_max_columns', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({max_columns: this.value})
                    });
                };
            }
        });

        function setMaxColumns(cols) {
            const row = document.querySelector('.rating-row');
            if (row) {
                row.style.gridTemplateColumns = '';
                row.style.flexWrap = '';
                row.style.display = 'flex';
                row.style.display = 'grid';
                row.style.gridTemplateColumns = `repeat(${cols}, minmax(120px, 1fr))`;
                row.style.flexWrap = '';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const titleElem = document.getElementById('editable-title');
            if (titleElem) {
                titleElem.ondblclick = openTitleEditPopup;
            }
        });

        function openTitleEditPopup() {
            const popup = document.getElementById('title-edit-popup');
            const input = document.getElementById('title-edit-input');
            const titleElem = document.getElementById('editable-title');
            const msg = document.getElementById('title-edit-msg');
            input.value = titleElem.innerText;
            msg.innerText = '';
            popup.style.display = 'flex';
            input.focus();
            input.select();
        }
        function closeTitleEditPopup() {
            document.getElementById('title-edit-popup').style.display = 'none';
        }
        function saveTitleEdit() {
            const input = document.getElementById('title-edit-input');
            const newTitle = input.value.trim();
            const msg = document.getElementById('title-edit-msg');
            if (!newTitle) {
                msg.innerText = "Title cannot be empty.";
                return;
            }
            fetch('/set_title', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title: newTitle})
            }).then(res => {
                if (!res.ok) return res.json().then(data => { throw data; });
                return res.json();
            }).then(() => {
                document.getElementById('editable-title').innerText = newTitle;
                closeTitleEditPopup();
            }).catch(err => {
                msg.innerText = (err && err.message) ? err.message : "Failed to save title.";
            });
        }

        function setRainbowGlow(enabled) {
            if (enabled) {
                document.body.classList.add('rainbow-glow-enabled');
            } else {
                document.body.classList.remove('rainbow-glow-enabled');
            }
        }

        function toggleRainbowGlow() {
            const enabled = document.getElementById('rainbow-glow-checkbox').checked;
            setRainbowGlow(enabled);
            fetch('/set_rainbow_glow', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rainbow_glow: enabled})
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            setRainbowGlow({{ config.get('rainbow_glow', True) | tojson }});
        });
    </script>
</body></html>